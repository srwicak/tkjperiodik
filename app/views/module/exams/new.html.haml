- content_for :title do
  Pendaftaran Ujian - Dasbor

- content_for :content do
  .max-w-4xl.mx-auto.w-full.my-8
    .divider.divider-start.text-3xl.text-red-500.font-black.mb-8.uppercase Pendaftaran Ujian
    .rounded-lg.p-8.bg-white.mb-8
      = render "exam_info"
      .divider
      = render "user_info"
      
      - if @available_schedules.empty?
        .alert.alert-warning
          %i.ri-information-line
          %span Belum ada jadwal ujian yang tersedia.
      - else
        = form_with url: new_module_exam_path(@exam.slug), method: :post, local: true, id: "registration-form", data: { dob: @user.user_detail&.date_of_birth&.strftime('%Y-%m-%d') } do |f|
          .divider.divider-start Data Tinggi & Berat Badan
          .mb-8
            %p.text-sm.text-gray-600.mb-4 Masukkan tinggi badan dan berat badan Anda saat ini untuk keperluan ujian.
            .grid.grid-cols-2.gap-4
              .form-control
                %label.label
                  %span.label-text.font-semibold
                    Tinggi Badan (cm)
                    %span.text-error *
                = f.number_field :tb, class: "input input-bordered w-full", placeholder: "Contoh: 170", required: true, min: 100, max: 250, id: "tb_field"
              .form-control
                %label.label
                  %span.label-text.font-semibold
                    Berat Badan (kg)
                    %span.text-error *
                = f.number_field :bb, class: "input input-bordered w-full", placeholder: "Contoh: 65", required: true, min: 30, max: 200, id: "bb_field"

          .divider.divider-start Pilih Jadwal Ujian

          .mb-8 
            %p.mb-6.font-semibold.text-xl Pilih Tanggal Ujian
            - if @user.user_detail.date_of_birth.blank?
              .alert.alert-error.mb-4
                %i.ri-error-warning-line
                %span Tanggal lahir Anda belum diisi. Silakan lengkapi profil Anda terlebih dahulu.
                %a.btn.btn-sm.btn-error.ml-2{ href: edit_module_profile_path } Lengkapi Profil
            .space-y-4.mb-6
              - @available_schedules.each do |schedule|
                - # Generate all dates in range, exclude weekends (Saturday=6, Sunday=0)
                - start_date = schedule.exam_date
                - end_date = schedule.exam_date_end.presence || schedule.exam_date
                - date_range = (start_date..end_date).to_a.reject { |date| date.wday == 0 || date.wday == 6 }
                - date_range.each do |exam_date|
                  - exam_session = schedule.exam_sessions.find { |s| s.start_time.to_date == exam_date }
                  - session_count = exam_session ? exam_session.registration_count : 0
                  .border.rounded-lg.p-4.cursor-pointer.transition-colors.hover:bg-base-200{ onclick: "selectSchedule(this, '#{schedule.id}_#{exam_date.to_s}')", data: { exam_date: exam_date.to_s, schedule_id: schedule.id } }
                    .flex.items-start.gap-3
                      = f.radio_button :selected_date, "#{schedule.id}|#{exam_date.to_s}", required: true, class: "radio radio-primary mt-1", id: "selected_date_#{schedule.id}_#{exam_date.to_s.gsub('-', '_')}"
                      .flex-1
                        %label.cursor-pointer{ for: "selected_date_#{schedule.id}_#{exam_date.to_s.gsub('-', '_')}" }
                          .font-bold.text-lg
                            %i.ri-calendar-line.text-primary
                            = exam_date.strftime("%A, %d %B %Y")
                          .text-sm.text-gray-600.mt-1
                            %i.ri-time-line
                            %strong Jam: 
                            = schedule.start_time.strftime("%H:%M")
                            -
                            = schedule.end_time.strftime("%H:%M")
                            WIB
                          .text-sm.text-gray-600
                            %strong Nama: 
                            = schedule.display_name
                          .text-sm.text-gray-600
                            %strong Satuan: 
                            = schedule.unit_names.join(", ")
                          .text-sm.text-gray-600
                            %strong Peserta Terdaftar: 
                            %span.font-bold.text-primary= session_count
                            - if schedule.max_participants
                              = " / #{schedule.max_participants}"
                            orang
                          - if @user.user_detail.date_of_birth.present?
                            .mt-3.p-3.bg-blue-50.rounded-lg.border.border-blue-200.age-info{ data: { exam_date: exam_date.to_s } }
                              .text-sm.font-semibold.text-blue-800.mb-1
                                %i.ri-user-heart-line.mr-1
                                Umur Anda saat ujian:
                              .text-base.font-bold.text-blue-900.age-display
                                Menghitung...
                              .mt-2.text-sm.font-semibold
                                %span.text-gray-600 Kategori Ujian: 
                                %span.badge.badge-lg.age-category-badge
                                  Menghitung...
                              .text-xs.text-gray-500.mt-2.italic.age-category-desc
                          - if schedule.notes.present?
                            .text-sm.text-gray-600.mt-2
                              %i.ri-information-line
                              = schedule.notes

          = f.hidden_field :reg_type, value: 'berkala'
          = f.hidden_field :golongan, value: '', id: 'golongan_field'
    
    - if @available_schedules.present?
      - if @user.user_detail.date_of_birth.blank?
        .alert.alert-error.mb-6
          %i.ri-error-warning-line
          %span.font-bold Tanggal lahir Anda belum diisi. Silakan lengkapi profil Anda terlebih dahulu untuk dapat mendaftar ujian.
          %a.btn.btn-error.ml-4{ href: edit_module_profile_path } Lengkapi Profil
      - else
        %button.btn.btn-lg.btn-success.w-full.text-white.font-bold{ type: "button", onclick: "validateAndShowModal()" } DAFTAR UJIAN

  %dialog#confirm_modal.modal
    .modal-box
      %h3.text-lg.font-bold.uppercase.mb-4 konfirmasi pendaftar ujian

      .mb-4 
        %p Dengan menekan tombol konfirmasi di bawah ini, maka Anda telah membaca keseluruhan informasi ujian di laman ini serta data diri Anda telah diperbarui dan sesuai
      .flex.gap-x-2
        %button.btn.px-16{ type: "button", onclick: "document.getElementById('confirm_modal').close()" } Batal
        %button.btn.btn-success.grow.text-white.uppercase{ type: "button", onclick: "document.getElementById('registration-form').submit()" } Konfirmasi

:javascript
  // Validate TB and BB before showing modal
  function validateAndShowModal() {
    const tbField = document.getElementById('tb_field');
    const bbField = document.getElementById('bb_field');
    const tbValue = tbField.value.trim();
    const bbValue = bbField.value.trim();
    
    // Check if fields are empty
    if (!tbValue || !bbValue) {
      let errorMessage = 'Harap lengkapi data berikut:\n';
      if (!tbValue) errorMessage += '- Tinggi Badan\n';
      if (!bbValue) errorMessage += '- Berat Badan\n';
      
      alert(errorMessage);
      
      // Focus on first empty field
      if (!tbValue) {
        tbField.focus();
      } else if (!bbValue) {
        bbField.focus();
      }
      return false;
    }
    
    // Validate TB range
    const tb = parseInt(tbValue);
    if (tb < 100 || tb > 250) {
      alert('Tinggi badan harus antara 100-250 cm');
      tbField.focus();
      return false;
    }
    
    // Validate BB range
    const bb = parseInt(bbValue);
    if (bb < 30 || bb > 200) {
      alert('Berat badan harus antara 30-200 kg');
      bbField.focus();
      return false;
    }
    
    // Check if a date is selected
    const selectedDate = document.querySelector('input[name="selected_date"]:checked');
    if (!selectedDate) {
      alert('Silakan pilih tanggal ujian terlebih dahulu');
      return false;
    }
    
    // All validations passed, show modal
    confirm_modal.showModal();
  }
  
  // Calculate age at specific date
  // Fixed for Safari/WebKit compatibility
  function calculateAge(dob, examDate) {
    // Parse dates manually to avoid Safari timezone issues
    // Expected format: YYYY-MM-DD
    const parseDateSafely = (dateStr) => {
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        // Create date with year, month (0-indexed), day
        // This avoids timezone issues in Safari
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      }
      // Fallback: try native parsing
      return new Date(dateStr);
    };
    
    const birthDate = parseDateSafely(dob);
    const targetDate = parseDateSafely(examDate);
    
    // Validate dates
    if (isNaN(birthDate.getTime()) || isNaN(targetDate.getTime())) {
      console.error('Invalid date format:', dob, examDate);
      return { years: 0, months: 0, days: 0 };
    }
    
    let years = targetDate.getFullYear() - birthDate.getFullYear();
    let months = targetDate.getMonth() - birthDate.getMonth();
    let days = targetDate.getDate() - birthDate.getDate();
    
    // Adjust years if birthday hasn't occurred yet this year
    if (months < 0 || (months === 0 && days < 0)) {
      years--;
      months += 12;
    }
    
    // Adjust months and days
    if (days < 0) {
      months--;
      if (months < 0) {
        years--;
        months += 12;
      }
      // Get days in previous month
      const prevMonth = new Date(targetDate.getFullYear(), targetDate.getMonth(), 0);
      days = prevMonth.getDate() - birthDate.getDate() + targetDate.getDate();
    }
    
    return { years, months, days };
  }
  
  function getAgeCategory(years) {
    if (years < 31) return '1';
    if (years < 41) return '2';
    if (years < 51) return '3';
    return '4';
  }
  
  function getCategoryBadgeClass(category) {
    switch(category) {
      case '1': return 'badge-success';
      case '2': return 'badge-info';
      case '3': return 'badge-warning';
      case '4': return 'badge-error';
      default: return 'badge-neutral';
    }
  }
  
  function getCategoryDescription(category) {
    switch(category) {
      case '1': return 'Golongan 1: Di bawah 31 tahun';
      case '2': return 'Golongan 2: 31 - 40 tahun';
      case '3': return 'Golongan 3: 41 - 50 tahun';
      case '4': return 'Golongan 4: 51 tahun ke atas';
      default: return '';
    }
  }
  
  function selectSchedule(element, scheduleKey) {
    document.querySelectorAll('.border.rounded-lg').forEach(el => {
      el.classList.remove('bg-base-200', 'border-primary');
    });
    element.classList.add('bg-base-200', 'border-primary');
    const radioBtn = document.getElementById('selected_date_' + scheduleKey);
    radioBtn.checked = true;
    
    // Update golongan field based on selected exam date
    updateGolongan(element.dataset.examDate);
  }
  
  function updateGolongan(examDateStr) {
    const form = document.getElementById('registration-form');
    const dobStr = form?.dataset.dob;
    
    if (dobStr && examDateStr) {
      const ageData = calculateAge(dobStr, examDateStr);
      const category = getAgeCategory(ageData.years);
      document.getElementById('golongan_field').value = category;
      console.log('Golongan set to:', category, 'for exam date:', examDateStr);
    }
  }
  
  // Initialize age calculations
  function initAgeCalculation() {
    const form = document.getElementById('registration-form');
    const dobStr = form?.dataset.dob;
    
    if (!dobStr) return;
    
    document.querySelectorAll('.age-info').forEach(function(ageInfo) {
      const examDateStr = ageInfo.dataset.examDate;
      if (!examDateStr) return;
      
      const ageData = calculateAge(dobStr, examDateStr);
      const category = getAgeCategory(ageData.years);
      
      // Update age display
      const ageDisplay = ageInfo.querySelector('.age-display');
      if (ageDisplay) {
        ageDisplay.textContent = `${ageData.years} tahun ${ageData.months} bulan ${ageData.days} hari`;
      }
      
      // Update category badge
      const categoryBadge = ageInfo.querySelector('.age-category-badge');
      if (categoryBadge) {
        categoryBadge.textContent = `Golongan ${category}`;
        categoryBadge.className = 'badge badge-lg ' + getCategoryBadgeClass(category);
      }
      
      // Update category description
      const categoryDesc = ageInfo.querySelector('.age-category-desc');
      if (categoryDesc) {
        categoryDesc.textContent = getCategoryDescription(category);
      }
    });
    
    // Add event listeners to all radio buttons
    document.querySelectorAll('input[name="selected_date"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (this.checked) {
          const scheduleCard = this.closest('.border.rounded-lg');
          if (scheduleCard) {
            const examDateStr = scheduleCard.dataset.examDate;
            if (examDateStr) {
              updateGolongan(examDateStr);
            }
          }
        }
      });
    });
  }
  
  // Run on both DOMContentLoaded AND immediate (handles both cases)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAgeCalculation);
  } else {
    initAgeCalculation();
  }

= render "layouts/dashboard"
