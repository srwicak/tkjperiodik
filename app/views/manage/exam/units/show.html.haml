- content_for :additional_head do
  %script{src: "https://oss.sheetjs.com/sheetjs/xlsx.full.min.js", type: "text/javascript"}

- content_for :title do
  Peserta Ujian Berdasarkan Kesatuan - Dasbor

- content_for :content do
  .mobile-message
    .mt-8.bg-yellow-100.border-l-4.border-yellow-500.text-yellow-700.p-4
      %p.font-bold Maaf, laman ini tidak bisa diakses dengan ponsel.
  .desktop-content
    .text-3xl.font-black.my-8
      %a{ class:"p-1 bg-gray-400 rounded-full hover:bg-gray-600 hover:text-white text-3xl", href: show_manage_exam_active_path(params[:slug]) } 
        %i.ri-arrow-left-line
      %span.ml-2 #{@exam.name} 
      %p.mt-4.text-xl.font-bold.bg-red-600.p-2.text-white Kesatuan: #{@unit} 

    -# Temporarily hidden - statistik peserta section
    -# .divider.divider-start.uppercase.text-gray-400.font-bold.mt-8 statistik peserta
    -#
    -# =render "statistic"

    -# Temporarily hidden - data nilai section
    -# .divider.divider-start.uppercase.text-gray-400.font-bold.mt-8 data nilai
    -# 
    -# =render "upload_excel"


    .divider.divider-start.uppercase.text-gray-400.font-bold.mt-8 daftar peserta - kenaikan pangkat
    .flex.justify-between
      .my-2.text-lg.font-bold Belum dinilai
      .my-2.text-lg
        .btn.btn-primary.btn-sm#download-rank-no.uppercase download xlsx
    #data-rank-no
    .flex.justify-between
      .my-2.text-lg.font-bold Sudah dinilai
      .my-2.text-lg
        .btn.btn-primary.btn-sm#download-rank-ok.uppercase download xlsx
    #data-rank-ok
    
    .divider.divider-start.uppercase.text-gray-400.font-bold.mt-8 daftar peserta - berkala
    .flex.justify-between
      .my-2.text-lg.font-bold Belum dinilai
      .my-2.text-lg
        .btn.btn-primary.btn-sm#download-reg-no.uppercase download xlsx
    #data-reg-no
    .flex.justify-between
      .my-2.text-lg.font-bold Sudah dinilai
      .my-2.text-lg
        .btn.btn-primary.btn-sm#download-reg-ok.uppercase download xlsx
    #data-reg-ok

= render "layouts/dashboard"

:javascript
  var tableConfigs = [
    { id: "#data-rank-ok", endpoint: "/kelola/ujian/#{params[:slug]}/kesatuan/#{params[:unit]}/data?registration_type=kenaikan_pangkat&with_score=true", buttonId: "#download-rank-ok", fileName: "kenaikan_pangkat_score.xlsx" },
    { id: "#data-rank-no", endpoint: "/kelola/ujian/#{params[:slug]}/kesatuan/#{params[:unit]}/data?registration_type=kenaikan_pangkat&with_score=false", buttonId: "#download-rank-no", fileName: "kenaikan_pangkat_no_score.xlsx" },
    { id: "#data-reg-ok", endpoint: "/kelola/ujian/#{params[:slug]}/kesatuan/#{params[:unit]}/data?registration_type=berkala&with_score=true", buttonId: "#download-reg-ok", fileName: "berkala_score.xlsx" },
    { id: "#data-reg-no", endpoint: "/kelola/ujian/#{params[:slug]}/kesatuan/#{params[:unit]}/data?registration_type=berkala&with_score=false", buttonId: "#download-reg-no", fileName: "berkala_no_score.xlsx" }
  ];

  tableConfigs.forEach((config) => {
    let table = new Tabulator(config.id, {
      minHeight: 300,
      pagination: true,
      paginationMode: "remote",
      filterMode: "remote",
      ajaxURL: config.endpoint,
      paginationSize: 10,
      paginationSizeSelector: [10, 25, 50],
      layout: "fitDataFill",
      rowHeader: {
        formatter: "rownum",
        headerSort: false,
        hozAlign: "center",
        vertAlign: "middle",
        resizable: false,
        frozen: true
      },
      columns: [
        { title: "NRP/NIP", field: "identity", width: 100, resizable: false, headerSort: false, vertAlign: "middle" },
        { title: "Nama", field: "name", width: 250, headerSort: false, vertAlign: "middle" },
        { title: "Nilai", field: "score_number", width: 60, headerSort: false, vertAlign: "middle" },
        {
          title: "Waktu Daftar", field: "created_at", width: 150, formatter: "datetime", headerSort: false, vertAlign: "middle",
          formatterParams: {
            inputFormat: "iso",
            outputFormat: "HH:mm:ss dd/MM/yy",
            invalidPlaceholder: "[invalid date]",
            timezone: "Asia/Jakarta"
          }
        },
        {
          title: "Aksi", width: 100, hozAlign: "center", headerHozAlign: "center", vertAlign: "middle", frozen: true, headerSort: false,
          formatter: (cell, formatterParams, onRendered) => {
            let link = cell.getRow().getData().user_status != "active" ? "nonaktif/" : "";
            let showButton = document.createElement("a");
            showButton.className = "btn btn-sm rounded-lg btn-primary uppercase";
            showButton.innerHTML = "<i class=ri-search-line></i>";
            showButton.href = "/kelola/pengguna/" + link + cell.getRow().getData().user_slug;

            let editButton = document.createElement("a");
            editButton.className = "btn btn-sm rounded-lg btn-secondary uppercase";
            editButton.innerHTML = "<i class=ri-input-method-line></i>";
            editButton.href = "/kelola/nilai/" + cell.getRow().getData().score_slug;

            let container = document.createElement("div");
            container.className = "flex space-x-2";
            container.appendChild(showButton);
            container.appendChild(editButton);

            return container;
          }
        }
      ]
    });

    // Trigger download with dynamic file name
    document.querySelector(config.buttonId).addEventListener("click", function(){
      table.download("xlsx", config.fileName, {sheetName: "My Data"});
    });
  });
