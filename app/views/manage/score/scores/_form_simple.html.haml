= form_with(model: @score, url: @url, method: @method, local: true) do |form|
  .bg-white.p-6.rounded-xl( x-data="scoreForm(#{@score_data.to_json.html_safe}, '#{@score.notes}', #{@golongan}, #{@is_male})" )
    .mb-4.flex.justify-end 
      %p.p-2.bg-red-500.text-white.font-bold.text-sm Kode: #{@score.code[0, 3]}-#{@score.code[-4, 4]}
    %table.w-full.text-left.border.border-separate.rounded.border-slate-200(cellspacing="0")
      %thead
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center{ class: "w-[20px]" } No
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center Materi Peserta
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center{ class: "w-[150px]" } Hasil (meter/kali/detik)
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center{ class: "w-[100px]" } Nilai
      
      - @categories.each do |category|
        %tbody
          %tr
            %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="6")= category[:name]
            - category[:content].each_with_index do |item, index|
              %tr.transition-colors.duration-300.hover:bg-slate-50
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.text-center{ class: "w-[20px]" }= index + 1
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500= item[:subject]
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.text-center{ class: "w-[150px]" }
                  - is_first_input = (category == @categories.first && index == 0 && @is_scored)
                  - # Input untuk raw value (meter/kali/detik)
                  %input.input.input-bordered.text-center.p-2{ 
                    class: "w-full", 
                    type: "text",
                    inputmode: "decimal",
                    placeholder: "Contoh: 3444", 
                    "x-model": "rawValues['#{item[:code]}']", 
                    "@input": "convertToScore('#{item[:code]}')", 
                    autofocus: is_first_input 
                  }
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.text-center{ class: "w-[100px]" }
                  - # Display score (readonly, auto-calculated)
                  %div.p-2.bg-gray-100.rounded.font-bold{ "x-text": "score['#{item[:code]}'] || '-'" }

      %tbody
        %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="6") catatan opsional (Maksimal 1000 karakter)
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ colspan: "6" }
            = form.text_area :notes, class: "textarea textarea-bordered w-full", rows: "3", maxlength: "1000", "x-model": "notes"
        
      %tfoot
        %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="6") Perhitungan Nilai
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ colspan: "3" } Nilai Akhir
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ "x-text": "averageScore" }
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ colspan: "3" }
            %span.italic Grade Nilai
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ "x-text": "gradeScore" }      
        %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="6")

    = form.hidden_field :score_detail, "x-bind:value":"JSON.stringify({raw: rawValues, score: score})"
    = form.hidden_field :score_number, "x-bind:value":"averageScore"
    = form.hidden_field :score_grade, "x-bind:value":"gradeScore"
      
    %button.btn.btn-success.w-full.btn-lg.font-bold.uppercase.text-white.mt-6 Simpan Nilai

:javascript
  function scoreForm(scores, notes, golongan, isMale) {
    return {
      scores: scores || { raw: {}, score: {} },
      rawValues: {},
      totalScore: 0,
      averageScore: 0,
      passingScore: 60,
      gradeScore: "",
      notes: notes || "",
      isPassed: false,
      score: {},
      useSimplifiedForm: #{@use_simplified_form},
      scoringStandards: null,
      golongan: golongan,
      jenis_kelamin: isMale ? 'pria' : 'wanita',
      
      async init() {
        // Load raw values from score_detail if editing
        this.rawValues = this.scores.raw || {};
        this.score = this.scores.score || {};
        this.remarks = this.scores.remarks;
        
        // Fetch scoring standards from API
        await this.loadScoringStandards();
        
        // Recalculate scores from raw values if editing
        if (Object.keys(this.rawValues).length > 0) {
          Object.keys(this.rawValues).forEach(testCode => {
            if (this.rawValues[testCode]) {
              this.convertToScore(testCode);
            }
          });
        }
        
        this.calculateScore();
      },
      
      async loadScoringStandards() {
        try {
          const response = await fetch(`/api/scoring_standards?golongan=${this.golongan}&jenis_kelamin=${this.jenis_kelamin}`);
          const data = await response.json();
          
          if (data.error) {
            console.error('Error loading scoring standards:', data.error);
            alert('Gagal memuat standar penilaian. Silakan refresh halaman.');
            return;
          }
          
          this.scoringStandards = data.lookup_data;
          console.log('Scoring standards loaded:', this.scoringStandards);
        } catch (error) {
          console.error('Failed to fetch scoring standards:', error);
          alert('Gagal memuat standar penilaian. Silakan refresh halaman.');
        }
      },
      
      convertToScore(testCode) {
        if (!this.scoringStandards) {
          console.warn('Scoring standards not loaded yet');
          return;
        }
        
        const rawValue = this.rawValues[testCode];
        if (!rawValue || rawValue === '') {
          this.score[testCode] = 0;
          this.calculateScore();
          return;
        }
        
        // Map test codes to scoring standard keys
        // IMPORTANT: For females, use 'chinning' instead of 'pullup'
        const testTypeMap = {
          'lari_12_menit': 'lari',
          'pull_ups': this.jenis_kelamin === 'pria' ? 'pullup' : 'chinning',
          'chinning': 'chinning',
          'sit_ups': 'situp',
          'push_ups': 'pushup',
          'shuttle_run': 'shuttlerun'
        };
        
        const testType = testTypeMap[testCode];
        if (!testType) {
          console.warn('Unknown test code:', testCode);
          return;
        }
        
        // Get lookup table for this test type
        const lookupTable = this.scoringStandards[testType];
        if (!lookupTable) {
          console.warn('No lookup table for test type:', testType);
          return;
        }
        
        // Lookup score
        const convertedScore = lookupTable[rawValue];
        
        if (convertedScore) {
          this.score[testCode] = convertedScore;
        } else {
          // If exact match not found, try to find closest value
          const closestScore = this.findClosestScore(lookupTable, rawValue, testType);
          this.score[testCode] = closestScore || 0;
        }
        
        this.calculateScore();
      },
      
      findClosestScore(lookupTable, rawValue, testType) {
        const values = Object.keys(lookupTable).map(v => {
          return testType === 'shuttlerun' ? parseFloat(v) : parseInt(v);
        }).sort((a, b) => a - b);
        
        const numValue = testType === 'shuttlerun' ? parseFloat(rawValue) : parseInt(rawValue);
        
        if (!numValue || isNaN(numValue)) return null;
        
        // Find closest value with interpolation logic:
        // - For lari/situp/pushup/pullup/chinning: higher is better, so round UP to next higher value
        // - For shuttlerun: lower time is better, but we round UP to worse performance (higher time)
        let closestValue = null;
        
        if (testType === 'shuttlerun') {
          // Shuttle run: lower time = better score (100), higher time = worse score (2)
          // If input is BELOW lowest time (fastest) -> return 100 (best score)
          if (numValue < values[0]) {
            return lookupTable[values[0].toString()]; // Return score for lowest time (100)
          }
          // If input is ABOVE highest time (slowest) -> return 2 (worst score)
          if (numValue > values[values.length - 1]) {
            return lookupTable[values[values.length - 1].toString()]; // Return score for highest time (2)
          }
          // Find the first value that is >= input (round up to worse performance)
          for (let i = 0; i < values.length; i++) {
            if (values[i] >= numValue) {
              closestValue = values[i];
              break;
            }
          }
        } else {
          // Lari, pullup, chinning, situp, pushup: higher value = better score
          // Find the first value that is >= input (round up to better performance)
          for (let i = 0; i < values.length; i++) {
            if (values[i] >= numValue) {
              closestValue = values[i];
              break;
            }
          }
          // If not found (input higher than all values), use the highest value
          if (!closestValue) closestValue = values[values.length - 1];
        }
        
        return lookupTable[closestValue.toString()];
      },
      
      calculateScore() {
        if (this.useSimplifiedForm) {
          // Simplified form: Only Lari 12 Menit
          const lariScore = parseInt(this.score['lari_12_menit']) || 0;
          this.totalScore = lariScore;
          this.averageScore = lariScore.toFixed(2);
        } else {
          // Full form: Average of B tests + A test, then average again
          const lariScore = parseInt(this.score['lari_12_menit']) || 0;
          
          // Check if using pull-ups or chinning based on gender
          const upperBodyTestCode = this.jenis_kelamin === 'pria' ? 'pull_ups' : 'chinning';
          const upperBodyScore = parseInt(this.score[upperBodyTestCode]) || 0;
          
          const sitUpsScore = parseInt(this.score['sit_ups']) || 0;
          const pushUpsScore = parseInt(this.score['push_ups']) || 0;
          const shuttleRunScore = parseInt(this.score['shuttle_run']) || 0;
          
          // Average of 4 B tests
          const bTestsAverage = (upperBodyScore + sitUpsScore + pushUpsScore + shuttleRunScore) / 4;
          
          // Add A test and average again
          this.totalScore = (bTestsAverage + lariScore) / 2;
          this.averageScore = this.totalScore.toFixed(2);
        }
        
        this.isPassed = this.averageScore >= this.passingScore;
        
        // New grading system (per 20 points)
        // 0-20: K2, 21-40: K1, 41-60: C, 61-80: B, 81-100: BS
        if (this.averageScore > 80) {
          this.gradeScore = "BS"
        } else if (this.averageScore > 60) {
          this.gradeScore = "B"
        } else if (this.averageScore > 40) {
          this.gradeScore = "C"
        } else if (this.averageScore > 20) {
          this.gradeScore = "K1"
        } else if (this.averageScore > 0) {
          this.gradeScore = "K2"
        } else {
          this.gradeScore = "Masukkan Nilai"
        }
      }
    }
  }