= form_with(model: @score, url: @url, method: @method, local: true) do |form|
  .bg-white.p-6.rounded-xl( x-data="scoreForm(#{@score_data.to_json.html_safe}, '#{@score.notes}')" )
    .mb-4.flex.justify-end 
      %p.p-2.bg-red-500.text-white.font-bold.text-sm Kode: #{@score.code[0, 3]}-#{@score.code[-4, 4]}
    %table.w-full.text-left.border.border-separate.rounded.border-slate-200(cellspacing="0")
      %thead
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center{ class: "w-[20px]" } No
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center Materi Peserta
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.uppercase.text-center nilai
      
      - @categories.each do |category|
        %tbody
          %tr
            %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="5")= category[:name]
            - category[:content].each_with_index do |item, index|
              %tr.transition-colors.duration-300.hover:bg-slate-50
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.text-center{ class: "w-[20px]" }= index + 1
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500= item[:subject]
                %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500.text-center{ class: "w-[120px]" }
                  %input.input.input-bordered.text-center.p-2{ class: "w-[60px]", inputmode: "numeric", oninput: "this.value = this.value.replace(/[^0-9]/g, '');", maxlength: "3", value: "", "x-model": "score['#{item[:code]}']", "@change": "calculateScore()" }

      %tbody
        %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="5") catatan opsional (Maksimal 1000 karakter)
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ colspan: "5" }
            = form.text_area :notes, class: "textarea textarea-bordered w-full", rows: "3", maxlength: "1000", "x-model": "notes"
        
      %tfoot
        %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="5") Perhitungan Nilai
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ colspan: "2" } Nilai Akhir
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ "x-text": "averageScore" }
        %tr.transition-colors.duration-300.hover:bg-slate-50
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ colspan: "2" }
            %span.italic Grade Nilai
          %td.h-12.p-2.text-sm.transition.duration-300.border-t.border-l.first:border-l-0.border-slate-200.stroke-slate-500.text-slate-500{ "x-text": "gradeScore" }      
        %th(scope="col" class="h-12 p-2 text-center uppercase text-sm stroke-slate-700 text-slate-700 bg-slate-100 rounded-t font-bold" colspan="5")

    = form.hidden_field :score_detail, "x-bind:value":"JSON.stringify(scores)"
    = form.hidden_field :score_number, "x-bind:value":"averageScore"
    = form.hidden_field :score_grade, "x-bind:value":"gradeScore"
      
    %button.btn.btn-success.w-full.btn-lg.font-bold.uppercase.text-white.mt-6 Simpan Nilai

:javascript
  function scoreForm(scores, notes) {
    return {
      scores: scores || { score: {} },
      totalScore: 0,
      averageScore: 0,
      passingScore: 60,
      gradeScore: "",
      notes: notes || "",
      isPassed: false,
      score: {},
      useSimplifiedForm: #{@use_simplified_form},
      init(){
        this.score = this.scores.score;
        this.remarks = this.scores.remarks;
        this.calculateScore();
      },
      calculateScore() {
        if (this.useSimplifiedForm) {
          // Simplified form: Only Lari 12 Menit
          const lariScore = parseInt(this.score['lari_12_menit']) || 0;
          this.totalScore = lariScore;
          this.averageScore = lariScore.toFixed(2);
        } else {
          // Full form: Average of B tests + A test, then average again
          const lariScore = parseInt(this.score['lari_12_menit']) || 0;
          const pullUpsScore = parseInt(this.score['pull_ups']) || 0;
          const sitUpsScore = parseInt(this.score['sit_ups']) || 0;
          const pushUpsScore = parseInt(this.score['push_ups']) || 0;
          const shuttleRunScore = parseInt(this.score['shuttle_run']) || 0;
          
          // Average of 4 B tests
          const bTestsAverage = (pullUpsScore + sitUpsScore + pushUpsScore + shuttleRunScore) / 4;
          
          // Add A test and average again
          this.totalScore = (bTestsAverage + lariScore) / 2;
          this.averageScore = this.totalScore.toFixed(2);
        }
        
        this.isPassed = this.averageScore >= this.passingScore;
        
        // Classification based on Excel formula
        // =IF(R8>=81;"BS";IF(R8>=61;"B";IF(R8>=41;"C";IF(R8>=31;"K";IF(R8<30;"KS")))))
        if (this.averageScore >= 81) {
          this.gradeScore = "BS"
        } else if (this.averageScore >= 61) {
          this.gradeScore = "B"
        } else if (this.averageScore >= 41) {
          this.gradeScore = "C"
        } else if (this.averageScore >= 31) {
          this.gradeScore = "K"
        } else if (this.averageScore > 0) {
          this.gradeScore = "KS"
        } else {
          this.gradeScore = "Masukkan Nilai"
        }
      }
    }
  }